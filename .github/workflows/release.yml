name: Create GitHub Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        default: 'v0.6.0'
      release_name:
        description: 'Release name'
        required: true
        default: 'PocketBrain v0.6.0 - Optimized, Camera-Ready, Device Sync'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            # Push to main branch - auto-release based on package.json version
            VERSION=$(jq -r '.version' package.json)
            TAG="v${VERSION}"
            echo "tag_name=${TAG}" >> $GITHUB_OUTPUT
            # Check if tag already exists
            if git tag -l "${TAG}" | grep -q "${TAG}"; then
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "Tag ${TAG} already exists, skipping release"
            else
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "Will create release for ${TAG}"
            fi
          fi

      - name: Create Release
        if: steps.tag.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: ${{ github.event.inputs.release_name || format('PocketBrain {0} - Optimized, Camera-Ready, Device Sync', steps.tag.outputs.tag_name) }}
          body: |
            ## ðŸš€ PocketBrain v0.6.0 - Optimized & Feature-Complete

            Faster startup, image memory, device sync UX, and text-to-speech. Everything you need for a personal AI brain.

            ### âš¡ Major Updates

            **Bundle Optimization (33x faster initial load)**
            - Lazy-load WebLLM instead of bundling at startup
            - Code splitting: 4 optimized chunks instead of monolithic bundle
            - Initial JS: 66KB (gzipped) â€” was 2MB+
            - Page loads in <1s on 4G (was 3-5s)
            - "Load Local AI" button â€” users choose when to activate WebLLM

            **ðŸ“· Camera / Image Memory**
            - Capture images directly in chat interface
            - Image preview + optional analysis/notes before saving
            - Responsive thumbnail grid in memory timeline
            - Ask your brain about captured images (context-aware retrieval)
            - Delete images anytime

            **ðŸ”„ Device Sync UX**
            - Enable/disable sync toggle in Settings
            - QR code pairing with step-by-step instructions
            - Copy code or share link for pairing on secondary devices
            - Manual "Sync now" button with last-sync timestamp
            - Sync status badge shows connected devices
            - Bug fix: pairing payload now properly applied

            **ðŸ”Š Text-to-Speech**
            - "Read aloud" button on all AI responses
            - Browser Web Speech API (no external dependencies)
            - Voice, rate, pitch, and volume controls in Settings
            - Gracefully disabled on browsers without TTS support

            ### ðŸŽ¯ Performance Metrics

            | Metric | Before | After |
            |--------|--------|-------|
            | Initial JS (gzipped) | 2MB+ | 66KB |
            | Page load time (4G) | 3-5s | <1s |
            | WebLLM load | At startup | On-demand (2-3s) |
            | Bundle chunks | 1 monolithic | 4 lazy chunks |

            ### ðŸš€ Quick Start

            **[Launch PocketBrain](https://michaelwave369.github.io/PocketBrain)** â€” No signup, no tracking, instant access.

            **Mobile**: Open on your phone and tap "Install" to add to home screen (PWA).

            **Self-hosted**:
            ```bash
            git clone https://github.com/MichaelWave369/PocketBrain.git
            cd PocketBrain
            npm ci && npm run dev
            ```

            ### ðŸ“‹ What's Coming Next

            - Full multi-device memory sync (foundation in place)
            - Video memory support
            - Local embeddings for semantic search
            - Offline-first service worker improvements
            - Bridge mode performance optimizations

            ### ðŸ”’ Privacy & License

            No telemetry. Your memory stays on your device. Bridge mode only sends compiled prompts to endpoints you control.

            **License**: Apache-2.0

            ---

            Built with â¤ï¸ for privacy and local-first AI.
          draft: false
          prerelease: false
